stream {
    upstream web {
        server 127.0.0.1:8443;
    }
    upstream turn {
        server 127.0.0.1:4443;
    }

    ## uncomment for debugging:
    # log_format basic '$remote_addr [$time_local] '
    #                  '$protocol $status $bytes_sent $bytes_received '
    #                  '$session_time';
    # access_log  /var/log/nginx/access-443.log basic;
    # error_log  /var/log/nginx/error-443.log debug;

    map $ssl_preread_server_name $upstream {
        ~\bturn\.   turn;
        ""          turn;
        default     web;
    }

    server {
        listen 443;
        listen [::]:443;

        # since 1.11.5
        ssl_preread on;
        proxy_pass $upstream;

        # Increase buffer to serve video
        proxy_buffer_size 10m;
    }
}
